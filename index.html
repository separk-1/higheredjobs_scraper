<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CE Faculty Job Scraper</title>
  <link rel="stylesheet" href="styles.css" />
  <script>const DEMO_MODE = false;</script>
</head>
<body>
  <header class="topbar">
    <h1>CE Faculty Job Scraper</h1>
    <div class="actions">
      <button id="startBtn" class="btn primary">Start</button>
      <button id="stopBtn" class="btn" disabled>Stop</button>
      <button id="manualBtn" class="btn">Run Once</button>
      <button id="clearBtn" class="btn danger outline">Clear</button>
    </div>
  </header>

  <main class="container">
    <section class="panel">
      <form id="controls" class="grid">
        <label>
          <span>Interval (s)</span>
          <input type="number" id="interval" value="300" min="60" max="3600" />
        </label>
        <label>
          <span>Max Jobs</span>
          <input type="number" id="maxJobs" value="100" min="10" max="500" />
        </label>
        <label class="wide">
          <span>Required (AND)</span>
          <input type="text" id="requiredKeywords" value="professor" placeholder="professor, assistant professor" />
        </label>
        <label class="wide">
          <span>Fields (OR)</span>
          <input type="text" id="fieldKeywords" value="civil, construction, building" placeholder="civil, construction, structural..." />
        </label>
      </form>
      <div class="statusbar">
        <div><strong>Status</strong> <span id="status">Idle</span></div>
        <div><strong>Last</strong> <span id="lastUpdate">-</span></div>
        <div><strong>Total</strong> <span id="jobCount">0</span></div>
        <div><strong>Next</strong> <span id="nextUpdate">-</span></div>
      </div>
    </section>

    <section class="panel">
      <nav class="tabs" role="tablist">
        <button class="tab active" data-tab="jobs">Jobs</button>
        <button class="tab" data-tab="json">JSON</button>
        <button class="tab" data-tab="html">HTML</button>
      </nav>

      <div class="toolbar">
        <button id="dlJson" class="btn small">Download JSON</button>
        <button id="dlHtml" class="btn small">Download HTML</button>
        <button id="dlCsv"  class="btn small">Download CSV</button>
      </div>

      <section id="tab-jobs" class="tabpane active">
        <div id="jobsList" class="list empty">Click Start to collect jobs.</div>
      </section>
      <section id="tab-json" class="tabpane">
        <pre id="jsonOutput" class="code">JSON will appear here…</pre>
      </section>
      <section id="tab-html" class="tabpane">
        <pre id="htmlOutput" class="code">HTML will appear here…</pre>
      </section>

      <details class="logwrap">
        <summary>Log</summary>
        <div id="log" class="log">[System] Ready.</div>
      </details>
    </section>
  </main>

  <script>
    let scrapingInterval, countdownInterval;
    let jobsData = [];
    let isRunning = false;

    function generateMockJobs(count) {
      const titles = ['Assistant Professor of Civil Engineering','Associate Professor of Construction Management','Professor of Structural Engineering'];
      const institutions = ['MIT - CEE','Stanford - CEE','UC Berkeley - CE','CMU - CEE'];
      const locations = ['Cambridge, MA','Stanford, CA','Berkeley, CA','Pittsburgh, PA'];
      const ranks = ['Assistant Professor','Associate Professor','Full Professor'];
      const specializations = ['Structural','Construction Mgmt','BIM','Geotech','Transportation'];
      const jobs=[];
      for (let i=0;i<count;i++){
        jobs.push({
          id: `job_${Date.now()}_${i}`,
          title: titles[Math.floor(Math.random()*titles.length)],
          institution: institutions[Math.floor(Math.random()*institutions.length)],
          location: locations[Math.floor(Math.random()*locations.length)],
          rank: ranks[Math.floor(Math.random()*ranks.length)],
          type: Math.random()>0.2?'Full-time':'Part-time',
          remote: Math.random()>0.8?'Hybrid':'On-site',
          specialization: specializations[Math.floor(Math.random()*specializations.length)],
          postedDate: new Date().toISOString().slice(0,10),
          deadline: new Date(Date.now()+30*864e5).toISOString().slice(0,10),
          salary: 'Competitive',
          description: 'Faculty position. Teaching and research expected.',
          url: 'https://www.higheredjobs.com/'
        });
      }
      return jobs;
    }

    function qs(sel){ return document.querySelector(sel); }
    function qsa(sel){ return Array.from(document.querySelectorAll(sel)); }

    function log(msg){
      const time = new Date().toLocaleTimeString();
      const el = qs('#log');
      el.innerHTML += `\n[${time}] ${msg}`;
      el.scrollTop = el.scrollHeight;
    }

    async function scrapeJobs(){
      log('Starting job scraping…');
      try{
        const maxJobs = parseInt(qs('#maxJobs').value);
        const req = qs('#requiredKeywords').value.trim();
        const fld = qs('#fieldKeywords').value.trim();

        let newJobs = [];
        if (DEMO_MODE){
          newJobs = generateMockJobs(Math.floor(Math.random()*6)+4);
        } else {
          const params = new URLSearchParams({ required: req, fields: fld });
          const res = await fetch(`/api/scrape?${params.toString()}`);
          if(!res.ok) throw new Error(`API ${res.status}`);
          const data = await res.json();
          newJobs = data.jobs || [];
        }

        const existing = new Set(jobsData.map(j=>j.id||`${j.title}|${j.url}`));
        const uniq = newJobs.filter(j=>!existing.has(j.id||`${j.title}|${j.url}`));
        jobsData = [...jobsData, ...uniq].slice(-maxJobs);

        updateDisplay();
        qs('#lastUpdate').textContent = new Date().toLocaleString();
        qs('#jobCount').textContent = String(jobsData.length);
        log(`Collected ${uniq.length}. Total ${jobsData.length}.`);
      }catch(e){
        log(`Error: ${e.message}`);
      }
    }

    function updateDisplay(){
      const list = qs('#jobsList');
      if(jobsData.length===0){ list.className='list empty'; list.textContent='No jobs.'; }
      else{
        list.className='list';
        list.innerHTML = jobsData.map(j=>`
          <article class="card">
            <header class="card-title">${j.title}</header>
            <div class="meta">
              <span>${j.institution||''}</span>
              <span>${j.location||''}</span>
              <span>${j.rank||''}</span>
              <span>${j.type||''}</span>
              <span>${j.remote||''}</span>
              <span>${j.specialization||''}</span>
            </div>
            ${j.description?`<p class="desc">${j.description}</p>`:''}
            <footer class="foot">
              <span>Posted ${j.postedDate||'-'}</span>
              <span>Deadline ${j.deadline||'-'}</span>
              <a href="${j.url}" target="_blank" rel="noopener">Open</a>
            </footer>
          </article>
        `).join('');
      }

      qs('#jsonOutput').textContent = JSON.stringify({
        lastUpdated: new Date().toISOString(),
        total: jobsData.length,
        criteria: { required: qs('#requiredKeywords').value, fields: qs('#fieldKeywords').value },
        jobs: jobsData
      }, null, 2);

      qs('#htmlOutput').textContent = `<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>CE Jobs</title></head><body>
<h1>CE Faculty Jobs</h1>
<p>Total ${jobsData.length} — ${new Date().toLocaleString()}</p>
${jobsData.map(j=>`
<section>
  <h2>${j.title}</h2>
  <div><strong>${j.institution||''}</strong> — ${j.location||''}</div>
  <div>${j.rank||''} · ${j.type||''} · ${j.remote||''} · ${j.specialization||''}</div>
  ${j.description?`<p>${j.description}</p>`:''}
  <small>Posted ${j.postedDate||'-'} • Deadline ${j.deadline||'-'} • <a href="${j.url}" target="_blank">Source</a></small>
</section>
`).join('')}
</body></html>`;
    }

    function startScraping(){
      if(isRunning) return;
      isRunning = true;
      qs('#startBtn').disabled = true;
      qs('#stopBtn').disabled = false;
      qs('#status').textContent = 'Running';

      const ms = parseInt(qs('#interval').value)*1000;
      scrapeJobs();
      scrapingInterval = setInterval(scrapeJobs, ms);
      startCountdown();
      log('Auto scraping started.');
    }

    function stopScraping(){
      if(!isRunning) return;
      isRunning = false;
      qs('#startBtn').disabled = false;
      qs('#stopBtn').disabled = true;
      qs('#status').textContent = 'Stopped';
      qs('#nextUpdate').textContent = '-';
      clearInterval(scrapingInterval);
      clearInterval(countdownInterval);
      log('Auto scraping stopped.');
    }

    function startCountdown(){
      const sec = parseInt(qs('#interval').value);
      let remain = sec;
      clearInterval(countdownInterval);
      countdownInterval = setInterval(()=>{
        if(!isRunning) return;
        remain = (remain<=1)?sec:remain-1;
        const m = Math.floor(remain/60);
        const s = String(remain%60).padStart(2,'0');
        qs('#nextUpdate').textContent = `${m}:${s}`;
      }, 1000);
    }

    function downloadJSON(){
      const blob = new Blob([qs('#jsonOutput').textContent], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`ce_jobs_${new Date().toISOString().slice(0,10)}.json`; a.click();
      URL.revokeObjectURL(url);
    }
    function downloadHTML(){
      const blob = new Blob([qs('#htmlOutput').textContent], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`ce_jobs_${new Date().toISOString().slice(0,10)}.html`; a.click();
      URL.revokeObjectURL(url);
    }
    function downloadCSV(){
      if(jobsData.length===0){ alert('No data.'); return; }
      const headers = ['Title','Institution','Location','Rank','Type','Remote','Specialization','Posted','Deadline','URL'];
      const rows = jobsData.map(j=>[j.title,j.institution,j.location,j.rank,j.type,j.remote,j.specialization,j.postedDate,j.deadline,j.url].map(v=>`"${(v??'').toString().replaceAll('"','""')}"`).join(','));
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`ce_jobs_${new Date().toISOString().slice(0,10)}.csv`; a.click();
      URL.revokeObjectURL(url);
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      qs('#startBtn').addEventListener('click', startScraping);
      qs('#stopBtn').addEventListener('click', stopScraping);
      qs('#manualBtn').addEventListener('click', ()=>{ log('Manual run.'); scrapeJobs(); });
      qs('#clearBtn').addEventListener('click', ()=>{ jobsData=[]; updateDisplay(); qs('#jobCount').textContent='0'; log('Cleared.'); });

      document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click', (e)=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        document.querySelectorAll('.tabpane').forEach(p=>p.classList.remove('active'));
        e.currentTarget.classList.add('active');
        const id = e.currentTarget.dataset.tab;
        document.querySelector(`#tab-${id}`).classList.add('active');
      }));

      qs('#dlJson').addEventListener('click', downloadJSON);
      qs('#dlHtml').addEventListener('click', downloadHTML);
      qs('#dlCsv').addEventListener('click', downloadCSV);
    });
  </script>
</body>
</html>
